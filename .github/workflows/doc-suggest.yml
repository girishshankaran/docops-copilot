name: Doc Suggestions

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  suggest:
    runs-on: ubuntu-latest
    env:
      DOCS_PAT: ${{ secrets.DOCS_PAT }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps
        run: |
          npm ci
          npm run build
      - name: Capture diff
        run: git diff --unified=3 HEAD^ HEAD > /tmp/diff.patch
      - name: Preflight auth checks
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || secrets.OPENAI_USER_APPKEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL || vars.OPENAI_BASE_URL || 'https://chat-ai.cisco.com/openai/deployments/gpt-4o-mini' }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL || 'gpt-4o-mini' }}
          OPENAI_USER: ${{ secrets.OPENAI_USER }}
          OPENAI_USER_APPKEY: ${{ secrets.OPENAI_USER_APPKEY }}
          DOCS_REPO: ${{ vars.DOCS_REPO || 'girishshankaran/docops-copilot-docs' }}
          GITHUB_TOKEN: ${{ secrets.DOCS_PAT }}
        run: |
          set -euo pipefail

          if [ -z "${GITHUB_TOKEN:-}" ]; then
            echo "DOCS_PAT is missing."
            exit 1
          fi
          if [ -z "${OPENAI_API_KEY:-}" ]; then
            echo "OPENAI_API_KEY (or OPENAI_USER_APPKEY fallback) is missing."
            exit 1
          fi
          if [ -z "${OPENAI_BASE_URL:-}" ]; then
            echo "OPENAI_BASE_URL is missing."
            exit 1
          fi
          OPENAI_USER_JSON="${OPENAI_USER:-}"
          if [ -z "${OPENAI_USER_JSON}" ] && [ -n "${OPENAI_USER_APPKEY:-}" ]; then
            OPENAI_USER_JSON="{\"appkey\":\"${OPENAI_USER_APPKEY}\"}"
          fi
          if [ -z "${OPENAI_USER_JSON}" ]; then
            echo "OPENAI_USER is missing (set OPENAI_USER or OPENAI_USER_APPKEY secret)."
            exit 1
          fi

          gh_code=$(curl -sS -o /tmp/docs_auth_check.json -w "%{http_code}" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${DOCS_REPO}")
          if [ "${gh_code}" -lt 200 ] || [ "${gh_code}" -ge 300 ]; then
            echo "DOCS_PAT cannot access ${DOCS_REPO}. HTTP ${gh_code}"
            head -c 500 /tmp/docs_auth_check.json || true
            echo
            exit 1
          fi
          echo "DOCS_PAT access check passed for ${DOCS_REPO}."

          llm_url="${OPENAI_BASE_URL%/}/chat/completions"
          jq -n \
            --arg model "${OPENAI_MODEL}" \
            --arg user "${OPENAI_USER_JSON}" \
            '{model:$model,user:$user,messages:[{role:"user",content:"ping"}],max_tokens:1}' \
            > /tmp/llm_preflight_payload.json
          llm_code=$(curl -sS -o /tmp/llm_auth_check.json -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "api-key: ${OPENAI_API_KEY}" \
            -X POST "${llm_url}" \
            -d @/tmp/llm_preflight_payload.json)
          if [ "${llm_code}" -lt 200 ] || [ "${llm_code}" -ge 300 ]; then
            echo "LLM auth/preflight failed at ${llm_url}. HTTP ${llm_code}"
            head -c 700 /tmp/llm_auth_check.json || true
            echo
            exit 1
          fi
          echo "LLM auth check passed."
      - name: Generate doc suggestions
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || secrets.OPENAI_USER_APPKEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL || vars.OPENAI_BASE_URL || 'https://chat-ai.cisco.com/openai/deployments/gpt-4o-mini' }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL || 'gpt-4o-mini' }}
          OPENAI_USER: ${{ secrets.OPENAI_USER }}
          OPENAI_USER_APPKEY: ${{ secrets.OPENAI_USER_APPKEY }}
          # Personal access token with repo scope so we can read the docs repo
          GITHUB_TOKEN: ${{ secrets.DOCS_PAT }}
          DOCS_BRANCH: ${{ vars.DOCS_BRANCH || 'main' }}
        run: |
          node dist/index.js \
            --diff /tmp/diff.patch \
            --docs-map docs-map.yaml \
            --docs-repo ${{ vars.DOCS_REPO || 'girishshankaran/docops-copilot-docs' }} \
            --docs-branch ${DOCS_BRANCH} \
            --out-dir suggestions \
            --code-repo ${{ github.repository }}
      - uses: actions/upload-artifact@v4
        with:
          name: doc-suggestions
          path: suggestions
      - name: Auto-apply patches to docs repo
        if: ${{ env.DOCS_PAT != '' }}
        env:
          DOCS_REPO: ${{ vars.DOCS_REPO || 'girishshankaran/docops-copilot-docs' }}
          DOCS_BRANCH: ${{ vars.DOCS_BRANCH || 'main' }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          set -euo pipefail
          if ! ls "$GITHUB_WORKSPACE"/suggestions/*.patch 1>/dev/null 2>&1; then
            echo "No patch files; skipping auto-apply."
            exit 0
          fi
          git config --global user.name "doc-bot"
          git config --global user.email "doc-bot@users.noreply.github.com"
          git clone --depth=1 "https://${DOCS_PAT}@github.com/${DOCS_REPO}.git" /tmp/docs-repo
          cd /tmp/docs-repo
          git checkout "${DOCS_BRANCH}"
          for p in "$GITHUB_WORKSPACE"/suggestions/*.patch; do
            echo "Applying $p"
            git apply "$p"
          done
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes after applying patches."
            exit 0
          fi
          git commit -am "Docs: auto-update from code change ($GITHUB_RUN_ID)"
          git push origin "${DOCS_BRANCH}"
        shell: bash
