name: Doc Suggestions

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  suggest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps
        run: |
          npm install -g ts-node typescript
          npm install openai @octokit/rest js-yaml minimatch
      - name: Capture diff
        run: git diff --unified=3 HEAD^ HEAD > /tmp/diff.patch
      - name: Generate doc suggestions
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL || 'gpt-4o-mini' }}
          OPENAI_USER: ${{ secrets.OPENAI_USER }}
          # Personal access token with repo scope so we can read the docs repo
          GITHUB_TOKEN: ${{ secrets.DOCS_PAT }}
          DOCS_BRANCH: ${{ vars.DOCS_BRANCH || 'main' }}
        run: |
          npx ts-node-esm src/index.ts \
            --diff /tmp/diff.patch \
            --docs-map docs-map.yaml \
            --docs-repo ${{ vars.DOCS_REPO || 'girishshankaran/docops-copilot-docs' }} \
            --docs-branch ${DOCS_BRANCH} \
            --out-dir suggestions \
            --code-repo ${{ github.repository }}
      - uses: actions/upload-artifact@v4
        with:
          name: doc-suggestions
          path: suggestions
      - name: Auto-apply patches to docs repo
        if: ${{ secrets.DOCS_PAT != '' }}
        env:
          DOCS_PAT: ${{ secrets.DOCS_PAT }}
          DOCS_REPO: ${{ vars.DOCS_REPO || 'girishshankaran/docops-copilot-docs' }}
          DOCS_BRANCH: ${{ vars.DOCS_BRANCH || 'main' }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          set -euo pipefail
          if ! ls "$GITHUB_WORKSPACE"/suggestions/*.patch 1>/dev/null 2>&1; then
            echo "No patch files; skipping auto-apply."
            exit 0
          fi
          git config --global user.name "doc-bot"
          git config --global user.email "doc-bot@users.noreply.github.com"
          git clone --depth=1 "https://${DOCS_PAT}@github.com/${DOCS_REPO}.git" /tmp/docs-repo
          cd /tmp/docs-repo
          git checkout "${DOCS_BRANCH}"
          for p in "$GITHUB_WORKSPACE"/suggestions/*.patch; do
            echo "Applying $p"
            git apply "$p"
          done
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes after applying patches."
            exit 0
          fi
          git commit -am "Docs: auto-update from code change ($GITHUB_RUN_ID)"
          git push origin "${DOCS_BRANCH}"
        shell: bash
