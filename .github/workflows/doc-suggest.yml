name: Doc Suggestions

on:
  push:
    branches: [main, copilot]
  pull_request:
    branches: [main, copilot]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  suggest:
    runs-on: ubuntu-latest
    env:
      DOCS_PAT: ${{ secrets.DOCS_PAT }}
      BRIDGE_OAUTH_BASIC: ${{ secrets.BRIDGE_OAUTH_BASIC || secrets.CISCO_OAUTH_BASIC }}
      BRIDGE_OAUTH_SCOPE: ${{ vars.BRIDGE_OAUTH_SCOPE || 'customscope' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps
        run: |
          npm ci
          npm run build
      - name: Capture diff
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            base_ref="${{ github.base_ref }}"
            # Fetch base branch with enough history to compute merge-base reliably.
            git fetch origin "${base_ref}"
            if merge_base="$(git merge-base "origin/${base_ref}" HEAD 2>/dev/null)"; then
              git diff --unified=3 "${merge_base}" HEAD > /tmp/diff.patch
            else
              echo "No merge-base between origin/${base_ref} and HEAD; falling back to two-dot diff."
              git diff --unified=3 "origin/${base_ref}..HEAD" > /tmp/diff.patch
            fi
          else
            before="${{ github.event.before }}"
            after="${{ github.sha }}"
            if [ -n "${before}" ] && [ "${before}" != "0000000000000000000000000000000000000000" ]; then
              git diff --unified=3 "${before}" "${after}" > /tmp/diff.patch
            else
              echo "Push event has no valid 'before' SHA; falling back to HEAD^..HEAD."
              git diff --unified=3 HEAD^ HEAD > /tmp/diff.patch
            fi
          fi
      - name: Mint Cisco Chat-AI access token
        env:
          AZURE_OPENAI_API_KEY_STATIC: ${{ secrets.AZURE_OPENAI_API_KEY || secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail

          if [ -n "${BRIDGE_OAUTH_BASIC:-}" ]; then
            token_json=$(curl -sS -X POST "https://id.cisco.com/oauth2/default/v1/token" \
              -H "Authorization: Basic ${BRIDGE_OAUTH_BASIC}" \
              -H "Content-Type: application/x-www-form-urlencoded" \
              --data "grant_type=client_credentials&scope=${BRIDGE_OAUTH_SCOPE}")
            access_token=$(echo "${token_json}" | jq -r '.access_token // empty')
            expires_in=$(echo "${token_json}" | jq -r '.expires_in // empty')
            if [ -z "${access_token}" ]; then
              echo "Failed to mint Cisco access token."
              echo "${token_json}" | head -c 700
              echo
              exit 1
            fi
            echo "::add-mask::${access_token}"
            echo "AZURE_OPENAI_API_KEY=${access_token}" >> "$GITHUB_ENV"
            echo "OPENAI_API_KEY=${access_token}" >> "$GITHUB_ENV"
            echo "Minted Cisco Chat-AI token (expires_in=${expires_in}s)."
          elif [ -n "${AZURE_OPENAI_API_KEY_STATIC:-}" ]; then
            echo "Using static AZURE_OPENAI_API_KEY/OPENAI_API_KEY secret fallback."
          else
            echo "No OAuth basic secret (BRIDGE_OAUTH_BASIC/CISCO_OAUTH_BASIC) and no static API key secret found."
            exit 1
          fi
      - name: Preflight auth checks
        env:
          AZURE_OPENAI_API_KEY_STATIC: ${{ secrets.AZURE_OPENAI_API_KEY || secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL || vars.OPENAI_BASE_URL || 'https://chat-ai.cisco.com/openai/deployments/gpt-4o-mini' }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL || 'gpt-4o-mini' }}
          OPENAI_USER: ${{ secrets.OPENAI_USER }}
          BRIDGE_API_APP_KEY: ${{ secrets.BRIDGE_API_APP_KEY || secrets.OPENAI_USER_APPKEY }}
          OPENAI_USER_APPKEY: ${{ secrets.OPENAI_USER_APPKEY }}
          DOCS_REPO: ${{ vars.DOCS_REPO || 'girishshankaran/docops-copilot-docs' }}
          GITHUB_TOKEN: ${{ secrets.DOCS_PAT }}
        run: |
          set -euo pipefail

          if [ -z "${AZURE_OPENAI_API_KEY:-}" ] && [ -n "${AZURE_OPENAI_API_KEY_STATIC:-}" ]; then
            AZURE_OPENAI_API_KEY="${AZURE_OPENAI_API_KEY_STATIC}"
          fi

          if [ -z "${GITHUB_TOKEN:-}" ]; then
            echo "DOCS_PAT is missing."
            exit 1
          fi
          if [ -z "${AZURE_OPENAI_API_KEY:-}" ]; then
            echo "AZURE_OPENAI_API_KEY (or OPENAI_API_KEY fallback) is missing."
            exit 1
          fi
          if [ -z "${OPENAI_BASE_URL:-}" ]; then
            echo "OPENAI_BASE_URL is missing."
            exit 1
          fi
          OPENAI_USER_JSON="${OPENAI_USER:-}"
          if [ -z "${OPENAI_USER_JSON}" ] && [ -n "${BRIDGE_API_APP_KEY:-}" ]; then
            OPENAI_USER_JSON="{\"appkey\":\"${BRIDGE_API_APP_KEY}\"}"
          fi
          if [ -z "${OPENAI_USER_JSON}" ] && [ -n "${OPENAI_USER_APPKEY:-}" ]; then
            OPENAI_USER_JSON="{\"appkey\":\"${OPENAI_USER_APPKEY}\"}"
          fi
          if [ -z "${OPENAI_USER_JSON}" ]; then
            echo "OPENAI_USER is missing (set OPENAI_USER or BRIDGE_API_APP_KEY secret)."
            exit 1
          fi

          gh_code=$(curl -sS -o /tmp/docs_auth_check.json -w "%{http_code}" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${DOCS_REPO}")
          if [ "${gh_code}" -lt 200 ] || [ "${gh_code}" -ge 300 ]; then
            echo "DOCS_PAT cannot access ${DOCS_REPO}. HTTP ${gh_code}"
            head -c 500 /tmp/docs_auth_check.json || true
            echo
            exit 1
          fi
          echo "DOCS_PAT access check passed for ${DOCS_REPO}."

          llm_url="${OPENAI_BASE_URL%/}/chat/completions"
          jq -n \
            --arg model "${OPENAI_MODEL}" \
            --arg user "${OPENAI_USER_JSON}" \
            '{model:$model,user:$user,messages:[{role:"user",content:"ping"}],max_tokens:1}' \
            > /tmp/llm_preflight_payload.json
          llm_code=$(curl -sS -o /tmp/llm_auth_check.json -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${AZURE_OPENAI_API_KEY}" \
            -H "api-key: ${AZURE_OPENAI_API_KEY}" \
            -X POST "${llm_url}" \
            -d @/tmp/llm_preflight_payload.json)
          if [ "${llm_code}" -lt 200 ] || [ "${llm_code}" -ge 300 ]; then
            echo "LLM auth/preflight failed at ${llm_url}. HTTP ${llm_code}"
            head -c 700 /tmp/llm_auth_check.json || true
            echo
            exit 1
          fi
          echo "LLM auth check passed."
      - name: Generate doc suggestions
        env:
          AZURE_OPENAI_API_KEY_STATIC: ${{ secrets.AZURE_OPENAI_API_KEY || secrets.OPENAI_API_KEY }}
          BRIDGE_API_APP_KEY: ${{ secrets.BRIDGE_API_APP_KEY || secrets.OPENAI_USER_APPKEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL || vars.OPENAI_BASE_URL || 'https://chat-ai.cisco.com/openai/deployments/gpt-4o-mini' }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL || 'gpt-4o-mini' }}
          LLM_ONLY: "true"
          OPENAI_USER: ${{ secrets.OPENAI_USER }}
          OPENAI_USER_APPKEY: ${{ secrets.OPENAI_USER_APPKEY }}
          # Personal access token with repo scope so we can read the docs repo
          GITHUB_TOKEN: ${{ secrets.DOCS_PAT }}
          DOCS_BRANCH: ${{ vars.DOCS_BRANCH || 'main' }}
        run: |
          if [ -z "${AZURE_OPENAI_API_KEY:-}" ] && [ -n "${AZURE_OPENAI_API_KEY_STATIC:-}" ]; then
            export AZURE_OPENAI_API_KEY="${AZURE_OPENAI_API_KEY_STATIC}"
          fi
          node dist/index.js \
            --diff /tmp/diff.patch \
            --docs-map docs-map.yaml \
            --docs-repo ${{ vars.DOCS_REPO || 'girishshankaran/docops-copilot-docs' }} \
            --docs-branch ${DOCS_BRANCH} \
            --out-dir suggestions \
            --code-repo ${{ github.repository }}
      - name: Show suggestion diagnostics
        run: |
          set -euo pipefail
          if [ -d suggestions ]; then
            echo "suggestions directory:"
            ls -la suggestions
            if [ -f suggestions/run-report.json ]; then
              echo "run-report.json:"
              cat suggestions/run-report.json
            fi
            if [ -f suggestions/suggestions.md ]; then
              echo "suggestions.md:"
              cat suggestions/suggestions.md
            fi
          else
            echo "No suggestions directory was created."
          fi
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: doc-suggestions
          path: suggestions
          if-no-files-found: warn
      - name: Enforce non-empty patch generation for mapped targets
        run: |
          set -euo pipefail
          report="suggestions/run-report.json"
          if [ ! -f "$report" ]; then
            echo "Missing $report"
            exit 1
          fi
          target_count=$(jq -r '.targetCount // 0' "$report")
          generated_count=$(jq -r '.generatedPatchCount // 0' "$report")
          if [ "$target_count" -gt 0 ] && [ "$generated_count" -eq 0 ]; then
            echo "Mapped targets were found but no valid patches were generated."
            echo "Failing run to avoid false-positive success."
            cat "$report"
            exit 1
          fi
          echo "Patch generation guardrail passed (targetCount=$target_count, generatedPatchCount=$generated_count)."
      - name: Auto-apply patches to docs repo
        if: ${{ env.DOCS_PAT != '' }}
        env:
          DOCS_REPO: ${{ vars.DOCS_REPO || 'girishshankaran/docops-copilot-docs' }}
          DOCS_BRANCH: ${{ vars.DOCS_BRANCH || 'main' }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          set -euo pipefail
          if ! ls "$GITHUB_WORKSPACE"/suggestions/*.patch 1>/dev/null 2>&1; then
            echo "No patch files; skipping auto-apply."
            exit 0
          fi
          git config --global user.name "doc-bot"
          git config --global user.email "doc-bot@users.noreply.github.com"
          git clone --depth=1 --branch "${DOCS_BRANCH}" "https://${DOCS_PAT}@github.com/${DOCS_REPO}.git" /tmp/docs-repo
          cd /tmp/docs-repo
          applied=0
          for p in "$GITHUB_WORKSPACE"/suggestions/*.patch; do
            echo "Applying $p"
            if git apply --check "$p"; then
              git apply "$p"
              applied=$((applied+1))
            else
              echo "Skipping invalid patch: $p"
            fi
          done
          if [ "$applied" -eq 0 ]; then
            echo "No valid patches to apply."
            exit 0
          fi
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes after applying patches."
            exit 0
          fi
          git add -A
          git commit -m "Docs: auto-update from code change ($GITHUB_RUN_ID)"
          git push origin "${DOCS_BRANCH}"
        shell: bash
